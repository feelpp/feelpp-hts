:page-plotly: true
:page-vtkjs: true
:stem: latexmath
:toc: left

= HTS Wire in 2D coordinates
:page-tags: hform
:page-illustration: Examples/cyl_H_2D_B_I_2.png 
:description: 2D magnetic transient model using H Formulation and E-J power law

:uri-data: https://github.com/feelpp/feelpp-hts/blob/master/src/cases
:uri-data-edit: https://github.com/feelpp/feelpp-hts/edit/master/src/cases

We took this example from : [[grilli]] __2-D H-Formulation of Maxwell's Equations with Edge Elements__ (shared by F. Grilli, Karlsruhe Institute of Technology and P. Masson, Houston University), https://www.htsmodelling.com/?page_id=748#2D_H_formulation[Link] .

== Description
stem:[\quad]In this example, we will build a magnetic model on a HTS wire geometry surrounded by air in 2D coordinates. We will use the *H Formulation*.
Thus stem:[\Omega] the domain contains the superconductor domain stem:[\Omega_c] and non conducting materials stem:[\Omega_c^C] (stem:[\mathbf{J} = 0]) like the air for example. Also stem:[\Gamma = \partial \Omega] is the bound of stem:[\Omega], stem:[\Gamma_c = \partial \Omega_c] the bound of stem:[\Omega_c].

[example,caption="",title="H Formulation"]
[[h_formulation]]
====
[stem]
++++
-\nabla\times \left(\rho \nabla\times \textbf{H}\right)=\partial_t(\mu \textbf{H}) \quad\text{ on } \Omega \quad \text{(H)} 
++++
with stem:[\rho] the resistivity following the *E-J power law* for the superconductor :
[stem]
++++
\rho=\frac{E_c}{J_c}\left(\frac{\mid\mid J \mid\mid}{J_c}\right)^{(n)}
++++

with :

* stem:[J_c]: the critical current density stem:[(A/m^2)]

* stem:[E_c]: the threshold electric field stem:[(V/m)]

* stem:[n]: material dependent exponent

* stem:[I]: applied current


In the air, we give the resistivity a high value like stem:[\rho_\text{air}=1].
====


=== Running the case

The command line to run this case is

[[command-line]]
[source,mpirun]
----
mpirun -np 32 feelpp_toolbox_coefficientformpdes --config-file=wire_2D.cfg
----

.Execution time
[width="50%",options="header,footer"]
|====================
| Feelpp (parallel np 32) |   
| 315 s |  
|====================

=== Equation 

The H Formulation in 2D coordinates is :

[example,caption="",title="H Formulation in 2D coordinates"]
====
[stem]
++++
\nabla\times\left(\rho\nabla\times H\right)  + \frac{\partial (\mu H)}{\partial t} = 0  \quad \text{on } \Omega^{2D} \quad \text{(H 2D)}
++++

With : 

* stem:[H] : magnetic field

* stem:[\rho] : electric resistivity stem:[\Omega \cdot m] described by the e-j power law : 
stem:[\rho=\frac{E_c}{J_c}\left(\frac{\mid\mid J \mid\mid}{J_c}\right)^{(n)}=\frac{E_c}{J_c}\left(\frac{\mid\mid \nabla\times \textbf{H} \mid\mid}{J_c}\right)^{(n)}]

* stem:[\mu] : electric permeability stem:[kg/A^2/S^2]

====

The model controls current through the wire with its outer boundary condition. The line integration of the tangential component of the
magnetic field on the boundary equals the applied transport current. Cylindrical symmetry results in a known magnetic field at the outer boundary :

[stem]
++++
I_\text{transport}=\oint_\Gamma H_\theta dl = 2\pi r H_\theta \Rightarrow H_\theta = \frac{I_\text{transport}}{2\pi r}
++++

So we have the Dirichlet boundary conditions :

[stem]
++++
H=H_\theta \cdot u_\theta = \frac{I_\text{transport}}{2\pi r} \cdot u_\theta=\frac{I_\text{transport}}{2\pi \sqrt{x^2+y^2}} (-sin(\theta) u_x +cos(\theta) u_y) =\frac{I_\text{transport}}{2\pi \sqrt{x^2+y^2}}\begin{pmatrix} -sin(\theta) \\ cos(\theta) \end{pmatrix}=\begin{pmatrix} H_x \\ H_y \end{pmatrix}
++++

=== Geometry

.Geometry with GMSH
|====
a|image:Cylinder/H-Formulation/cfpdes_2D/wire.png[,width=600]
|====

.Mesh with GMSH
|====
a|image:Cylinder/H-Formulation/cfpdes_2D/wiremesh.png[,width=600]
|====

== Input

.Parameter table

[width="100%",options="header,footer"]
|====================
| Notation | Description  | Value  | Unit  | Note
5+s|Param√®tres globale
|stem:[H] | magnetic field | |stem:[A/m] |
|stem:[rWire]| radius of the wire | stem:[0.001] | stem:[m] |
| stem:[I_c] | critical current | stem:[300] | stem:[A] |
| stem:[Iext] | maximum transport current | stem:[0.8 I_c] | stem:[A] |
| stem:[f] | frequency | stem:[50] | stem:[Hz] |
|stem:[Iapp]| transport current| stem:[Iext*\sin(2*\pi*f*t)] | stem:[A] |
|stem:[r\_xy]| cylindrical coordinates stem:[r]| stem:[\sqrt{x^2+y^2}] | stem:[m] |
|stem:[theta]| cylindrical coordinates stem:[\theta]| stem:[\text{atan2}(y,x)] | stem:[rad] |

5+s|Air
| stem:[\mu=\mu_0] | magnetic permeability of vacuum | stem:[4\pi.10^{-7}] | stem:[kg \, m / A^2 / S^2] |
| stem:[\rho] | electrical resistivity | stem:[1] | stem:[\Omega\cdot m] |

5+s|Conductor
| stem:[\mu=\mu_0] | magnetic permeability of vacuum | stem:[4\pi.10^{-7}] | stem:[kg \, m / A^2 / S^2] |
| stem:[J_c] | critical current density | stem:[\frac{I_c}{rWire^2\pi}\simeq 1e+08] | stem:[A/m^2] |
| stem:[E_c] | threshold electric field | stem:[10^{-4}] |stem:[V/m] |
| stem:[n] | material dependent exponent | stem:[25] | |
| stem:[\rho] | electrical resistivity (described by the stem:[e-j] power law) | stem:[\frac{E_c}{J_c}\left(\frac{\mid\mid J \mid\mid}{J_c}\right)^{(n-1)}] | stem:[\Omega\cdot m] |


|====================

== Data files

The case data files are available in Github link:{uri-data}/Cylinder/H-Formulation/cfpdes_2D[here]

* link:{uri-data}/Cylinder/H-Formulation/cfpdes_2D/wire_2D.cfg[CFG file] - [link:{uri-data-edit}/Cylinder/H-Formulation/cfpdes_2D/wire_2D.cfg[Edit the file]]
* link:{uri-data}/Cylinder/H-Formulation/cfpdes_2D/wire_2D.json[JSON file] - [link:{uri-data-edit}/Cylinder/H-Formulation/cfpdes_2D/wire_2D.json[Edit the file]]


=== Json file

==== Mesh

This section of the Model JSON file setup the mesh.

[source,json]
----
"Meshes":
    {
        "cfpdes":
        {
            "Import":
            {
                "filename":"$cfgdir/wire.geo"<1>
            }
        }
    },
----
<1> the geometric file

==== Materials

This section of the Model JSON file defines material properties linking the Physical Entities in the mesh data structures to these properties.

[source,json]
----
"Materials":
    {
        "Conductor":<1>
        {
            "markers":["Conductor"],<1>
            
            "rho":"ec / jc * (abs(magnetic_curl_H_rt)/jc)^(n - 1):ec:jc:n:magnetic_curl_H_rt",<2>
	        "mu":"mu0:mu0"
        },
        "Air":<1>
        {
	        "markers":["Air"],<1>

            "rho":1,
	        "mu":"mu0:mu0"
        }
    },
----
<1> gives the name of the physical entity (here `Physical Surface`) associated to the Material.
<2> stem:[\rho]  is defined by the E-J power law in the HTS

==== Models

This section of the Model JSON file defines material properties linking the Physical Entities in the mesh data structures to these properties.

[source,json]
----
"Models":<1>
    {
        "cfpdes":{
            "equations":"magnetic"<2>
        },
        "magnetic":<3>
        {
            "name": "magnetic_conductor",
            "setup":{
                "unknown":{
                    "basis":"Ned1h0",<4>
                    "name":"H",<5>
                    "symbol":"H"<6>
                },
                "coefficients":{<7>
                    "zeta":"materials_rho:materials_rho",
                    "d":"materials_mu:materials_mu"
                }
            }
        }
    },
----
<1> start section `Models` defined by the toolbox to define the main configuration and particularly the set of equations to be solved
<2> set of equations to be solved
<3> toolbox keyword that allows identifying the kind of model
<4> equation unknown's basis
<5> equation unknown's name
<6> equation unknown's symbol
<7> CFPDES coefficients




==== Boundary Conditions

This section of the Model JSON file defines the boundary conditions.

[source,json]
----
"BoundaryConditions":
    {
        "magnetic": <1>
        {
            "Dirichlet": <2>
            {
                "magdir":
                {
                    "markers":["Infty"], <3>
                    "expr": "{-Iapp/(2*pi*r_xy)*sin(theta),Iapp/(2*pi*r_xy)*cos(theta)}:Iapp:x:y:theta:r_xy" 
                }
            }
        }
    },
----
<1> the field name of the toolbox to which the boundary condition is associated
<2> the type of boundary condition to apply, here `Dirichlet`
<3> the physical entity (associated to the mesh) to which the condition is applied


==== Post Process
[source,json]
----
"PostProcess":
    {
        "use-model-name":1,
        "magnetic":<1>
        {
            "Exports":<2>
            {
                "fields":["H"],<3>
                "expr":<4>
                {
                    "B":<5>
                    {
                        "expr":"{materials_mu*magnetic_H_0,materials_mu*magnetic_H_1}:materials_mu:magnetic_H_0:magnetic_H_1",
                        "representation":["element"]
                    },
                    "J":<6>
                    {
                        "expr":"magnetic_curl_H:magnetic_curl_H",
                        "markers":["Conductor"]<7>
                    }
                }
            }
        }
    }
}
----
<1> the field name of the toolbox to which the post-processing is associated
<2> the `Exports` identifies the toolbox fields that have to be exported for visualisation
<3> the list of fields to be exported
<4> the list of expressions assiocated to the fields to be exported
<5> `B` is for the magnetic flux density
<6> `J` is for the current density
<7> the physical entity (associated to the mesh) to which the expression is applied

=== CFG file

The Model CFG (`.cfg`) files allow to pass command line options to {feelpp} applications. In particular, it allows to  define the solution strategy and configure the linear/non-linear algebraic solvers.

The Cfg file used is
[source,ini]
----
directory=feelpp-hts/cylinder/Hform/cfpdes_2D<1>

case.dimension=2<2>

[cfpdes]<3>
filename=$cfgdir/wire_2D.json<4>

verbose_solvertimer=1<5>
solver=Newton<6>

ksp-monitor=1<7>
ksp-view=1
ksp-converged-reason=1<8>

snes-type=ls
snes-line-search-type=bt
snes-monitor=1
snes-view=1
snes-maxit=200<9>
snes-atol=1.e-5<10>
#snes-rtol=1.e-6<11>
snes-converged-reason=1

pc-factor-mumps.icntl-14=200

[cfpdes.magnetic]<12>
bdf.order=2<13>

[ts]<14>
time-initial=0<15>
time-step=0.0002<16>
time-final=0.02<17>
restart.at-last-save=true<18>
----
<1> the directory where the results are exported
<2>	the dimension of the application, by default 3D
<3> toolbox prefix
<4> the associated Json file
<5> information on solver time
<6> the non-linear solver
<7> ksp-monitor
<8> ksp-converged-reason
<9> maximum number of iteration
<10> snes absolute tolerance
<11> snes relative tolerance
<12> cfpdes.magnetic
<13> cfpdes.magnetic order
<14> time setup
<15> time initial
<16> time step
<17> time final
<18> restart at last save

== Result

=== Electric current density

.Electric current density stem:[J (A/m^2)]
video::iy8hqy8e_1o[youtube, height=480, opts="autoplay,loop", theme=light]

We compare the distribution of the electric current density on the Oz axis between the tapes at the instant stem:[t=0.005s] with *Feelpp* and *Comsol*.

[plotly,https://gist.githubusercontent.com/jermuzet/843079626f67dfcdef2fd81ab63180a1/raw/0ca7592dabb683a70900d271dd4db8104f7c5593/Wire_Hform_2D_J.csv]
....
// global d
const data = [{
  name: 'Feel++',
  type: 'scatter',
  x: d.map(i => i['x']),
  y: d.map(i => i['Feel++']),
  showlegend: true,
  line: {color: '#2E64FE'}
},
{
  name: 'Comsol',
  type: 'scatter',
  x: d.map(i => i['x']),
  y: d.map(i => i['Comsol']),
  showlegend: true,
  line: {color: '#FF8000'}
}]
const layout = {
  title: 'Current Density',
  xaxis: {title: 'x (m)'},
  yaxis: {title: 'J/Jc'}
}
....

[cols="a"]
|===
^|*L2 Relative Error Norm* : stem:[22.15 \%]
|===

=== Magnetic flux density

.Magnetic flux density stem:[B (T)]
video::lidYEfeiPyY[youtube, height=480, opts="autoplay,loop", theme=light]


We compare the distribution of the y-component of the magnetic flux density on the Ox axis across the tapes at the instants stem:[t_1=0.005s] and stem:[t_2=0.010s] with *Feelpp* and *Comsol*.

[plotly,https://gist.githubusercontent.com/jermuzet/fe4cfeca637693594c5ee7413baa6b2a/raw/3336522bbed9cc6d899c5ed62227f4c3f8b6e6d3/Wire_Hform_2D_B.csv]
....
// global d
const data = [{
  name: 'Feel++ t1',
  type: 'scatter',
  x: d.map(i => i['x']),
  y: d.map(i => i['Feel++_t1']),
  showlegend: true,
  line: {color: '#088A08'}
},
{
  name: 'Comsol t1',
  type: 'scatter',
  x: d.map(i => i['x']),
  y: d.map(i => i['Comsol_t1']),
  showlegend: true,
  line: {color: '#81F781'}
},
{
  name: 'Feel++ t2',
  type: 'scatter',
  x: d.map(i => i['x']),
  y: d.map(i => i['Feel++_t2']),
  showlegend: true,
  line: {color: '#084B8A'}
},
{
  name: 'Comsol t2',
  type: 'scatter',
  x: d.map(i => i['x']),
  y: d.map(i => i['Comsol_t2']),
  showlegend: true,
  line: {color: '#2ECCFA'}
}]
const layout = {
  title: 'Magnetic Flux Density',
  xaxis: {title: 'x (m)'},
  yaxis: {title:'By (T)'}
}
....


[cols="1,3"]
|===
|*t1* stem:[=0.005s]
^|*L2 Relative Error Norm* : stem:[3.65 \%]
|*t2* stem:[=0.010s]
^|*L2 Relative Error Norm* : stem:[6.24 \%]
|===

=== Interactive view



[cols="a,a"]
|===
^|[vtkjs,https://girder.math.unistra.fr/api/v1/item/64d4ac7fb0e9570499e1e443/download]
----
{
  "fields": [
    {
      "scene": "magfield",
      "name": "Magnetic Field B"
    },
    {
      "scene": "currden",
      "name": "Current Density J"
    }
  ]
}
---- ^| [vtkjs,https://girder.math.unistra.fr/api/v1/item/64d4ac7fb0e9570499e1e440/download]
----
{
  "fields": [
    {
      "scene": "magfield",
      "name": "Magnetic Field B"
    },
    {
      "scene": "currden",
      "name": "Current Density J"
    }
  ]
}
----
^| stem:[t=0.005s] ^| stem:[t=0.010s]
^|[vtkjs,https://girder.math.unistra.fr/api/v1/item/64d4ac7eb0e9570499e1e43d/download]
----
{
  "fields": [
    {
      "scene": "magfield",
      "name": "Magnetic Field B"
    },
    {
      "scene": "currden",
      "name": "Current Density J"
    }
  ]
}
---- ^| [vtkjs,https://girder.math.unistra.fr/api/v1/item/64d4ac7eb0e9570499e1e43a/download]
----
{
  "fields": [
    {
      "scene": "magfield",
      "name": "Magnetic Field B"
    },
    {
      "scene": "currden",
      "name": "Current Density J"
    }
  ]
}
----
^| stem:[t=0.015s] ^| stem:[t=0.020s]
|===

Download export files to view results on https://www.paraview.org/download/[Paraview] : https://girder.math.unistra.fr/api/v1/folder/64d4afcab0e9570499e1e445/download[Wire_Hform_2D.zip]